name: PHP Release Draft (X.Y.Z format)

on:
  pull_request:
    types: [opened, reopened, labeled, unlabeled, synchronize]

jobs:
  draft-release:
    if: github.event.pull_request.merged == false
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.semver.outputs.VERSION }}
      changelog: ${{ steps.changelog.outputs.BODY }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get latest release
        id: latest-release
        uses: actions/github-script@v6
        with:
          script: |
            try {
              const { data } = await github.rest.repos.listReleases({
                owner: context.repo.owner,
                repo: context.repo.repo
              });
              if (data.length === 0) return null;
              return data.sort((a, b) =>
                new Date(b.published_at) - new Date(a.published_at)
              )[0].tag_name;
            } catch (e) {
              return null;
            }

      - name: Parse current version
        id: version-parse
        run: |
          TAG="${{ steps.latest-release.outputs.result }}"

          # Ğ•ÑĞ»Ğ¸ Ğ½ĞµÑ‚ Ñ€ĞµĞ»Ğ¸Ğ·Ğ¾Ğ² (TAG=null) â†’ Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°ĞµĞ¼ Ñ 0.0.1
          if [[ "$TAG! == "null" ]]; then
            echo "MAJOR=0" >> $GITHUB_OUTPUT
            echo "MINOR=0" >> $GITHUB_OUTPUT
            echo "PATCH=1" >> $GITHUB_OUTPUT
          # Ğ•ÑĞ»Ğ¸ Ñ‚ĞµĞ³ ÑƒĞ¶Ğµ Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ X.Y.Z (Ğ±ĞµĞ· Ğ¿Ñ€ĞµÑ„Ğ¸ĞºÑĞ° v)
          elif [[ -n "$TAG! && "$TAG! =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "MAJOR=$(echo "$TAG! | cut -d'.' -f1)" >> $GITHUB_OUTPUT
            echo "MINOR=$(echo "$TAG! | cut -d'.' -f2)" >> $GITHUB_OUTPUT
            echo "PATCH=$(echo "$TAG! | cut -d'.' -f3)" >> $GITHUB_OUTPUT
          fi

      - name: Determine SemVer bump (PHP-specific labels)
        id: semver
        run: |
          MAJOR=${{ steps.version-parse.outputs.MAJOR }}
          MINOR=${{ steps.version-parse.outputs.MINOR }}
          PATCH=${{ steps.version-parse.outputs.PATCH }}


          LABELS='${{ join(github.event.pull_request.labels.*.name, ',') }}'

          # Ğ“Ñ€ÑƒĞ¿Ğ¿Ñ‹ Ğ¼ĞµÑ‚Ğ¾Ğº Ğ¿Ğ¾ SemVer-ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸ÑĞ¼
          MAJOR_LABELS='break|breaking|major|deprecated|refactor|api-change|bc-break|downgrade|legacy'
          MINOR_LABELS='feature|enhancement|new|add|implement|psr-\d+|standards|coding-style|php\d+\.\d+|dependency-update|interface|trait|enum'
          PATCH_LABELS='fix|bug|patch|hotfix|security|vulnerability|test|coverage|performance|optimization|ci|cd|docs|documentation|changelog|readme|lint|format|typo'


          if echo "$LABELS! | grep -iqE "\b($MAJOR_LABELS)\b"; then
            NEW_MAJOR=$((MAJOR + 1))
            NEW_MINOR=0
            NEW_PATCH=0
          elif echo "$LABELS! | grep -iqE "\b($MINOR_LABELS)\b"; then
            NEW_MAJOR=$MAJOR
            NEW_MINOR=$((MINOR + 1))
            NEW_PATCH=0
          elif echo "$LABELS! | grep -iqE "\b($PATCH_LABELS)\b"; then
            NEW_MAJOR=$MAJOR
            NEW_MINOR=$MINOR
            NEW_PATCH=$((PATCH + 1))
          else
            # Default: patch
            NEW_MAJOR=$MAJOR
            NEW_MINOR=$MINOR
            NEW_PATCH=$((PATCH + 1))
          fi

          VERSION="${NEW_MAJOR}.${NEW_MINOR}.${NEW_PATCH}"
          echo "VERSION=$VERSION! >> $GITHUB_OUTPUT
          echo "SHORT=$VERSION! >> $GITHUB_OUTPUT


      - name: Generate Changelog
        id: changelog
        run: |
          PR_NUM=${{ github.event.pull_request.number }}
          PR_TITLE='${{ github.event.pull_request.title }}'
          PR_URL='${{ github.event.pull_request.html_url }}'
          AUTHOR='${{ github.event.pull_request.user.login }}'
          LABELS_STR='${{ join(github.event.pull_request.labels.*.name, ' Â· ') }}'

          cat << EOF > changelog.md
          ## Release ${{ steps.semver.outputs.VERSION }} (Draft)

          > ğŸ›  Autoâ€‘generated draft for PHP project. Review before publishing.

          ### PR Overview
          - **Title**: [$PR_TITLE]($PR_URL)
          - **Number**: #$PR_NUM
          - **Author**: @$AUTHOR
          - **Labels**: $LABELS_STR

          ### Change Categories
          $(
            if echo "$LABELS_STR! | grep -iq 'feature'; then
              echo "- âœ¨ Features"
            fi
            if echo "$LABELS_STR! | grep -iqE 'fix|bug|hotfix|security'; then
              echo "- ğŸ Bug Fixes & Security"
            fi
            if echo "$LABELS_STR! | grep -iqE 'refactor|deprecated|api-change'; then
              echo "- âš’ Refactoring & Deprecations"
            fi
            if echo "$LABELS_STR! | grep -iqE 'test|coverage'; then
              echo "- ğŸ§ª Tests & Coverage"
            fi
            if echo "$LABELS_STR! | grep -iqE 'docs|readme|changelog'; then
              echo "- ğŸ“ Documentation"
            fi
            if echo "$LABELS_STR! | grep -iqE 'performance|optimization'; then
              echo "- ğŸš€ Performance"
            fi
            if echo "$LABELS_STR! | grep -iqE 'ci|cd'; then
              echo "- ğŸ”§ CI/CD Improvements"
            fi
            if echo "$LABELS_STR! | grep -iqE 'psr'; then
              echo "- ğŸ“ PSR Standards"
            fi
            if echo "$LABELS_STR! | grep -iqE 'php\d+\.\d+'; then
              echo "- ğŸŒ PHP Version Support"
            fi
          )

          ### Details
          - $PR_TITLE ([#$PR_NUM]($PR_URL))

          ### Review Checklist
          - [ ] âœ… Backward compatibility (MAJOR/MINOR)
          - [ ] ğŸ“„ Update CHANGELOG.md and UPGRADE.md
          - [ ] ğŸ§ª Run tests (PHPUnit/Pest)
          - [ ] ğŸ” Check deprecations
          - [ ] ğŸŒ Test on PHP 8.0â€“8.3
          - [ ] ğŸ“¦ Composer validate

          ---
          _Generated: $(date +'%Y-%m-%d %H:%M') | Workflow: PHP Release Draft (X.Y.Z)_
          EOF

          BODY=$(cat changelog.md)
          echo "BODY<<EOF! >> $GITHUB_OUTPUT
          echo "$BODY! >> $GITHUB_OUTPUT
          echo "EOF! >> $GITHUB_OUTPUT


      - name: Create/Update Release Draft
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.semver.outputs.VERSION }}
          release_name: Release ${{ steps.semver.outputs.SHORT }}
          body: ${{ steps.changelog.outputs.BODY }}
          draft: true
          prerelease: false
