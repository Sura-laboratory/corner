name: PR ‚Üí Semantic Release Draft (PHP-optimized)


on:
  pull_request:
    types: [opened, reopened, labeled, unlabeled, synchronize]

jobs:
  create-release-draft:
    if: github.event.pull_request.merged == false
    runs-on: ubuntu-latest
    outputs:
      next_version: ${{ steps.calc-version.outputs.NEXT_VERSION }}
      changelog: ${{ steps.gen-changelog.outputs.CHANGELOG }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get latest release tag
        id: get-latest
        uses: actions/github-script@v6
        with:
          script: |
            try {
              const { data } = await github.rest.repos.listReleases({
                owner: context.repo.owner,
                repo: context.repo.repo
              });
              if (data.length === 0) return null;
              const latest = data.sort((a, b) =>
                new Date(b.published_at) - new Date(a.published_at)
              )[0];
              return latest.tag_name;
            } catch (e) {
              return null;
            }

      - name: Parse current version
        id: parse-version
        run: |
          CURRENT_TAG="${{ steps.get-latest.outputs.result }}"
          if [[ -z "$CURRENT_TAG" || "$CURRENT_TAG! != v* ]]; then
            echo "MAJOR=0" >> $GITHUB_OUTPUT
            echo "MINOR=0" >> $GITHUB_OUTPUT
            echo "PATCH=0" >> $GITHUB_OUTPUT
          else
            V="${CURRENT_TAG#v}"
            echo "MAJOR=$(echo "$V" | cut -d'.' -f1)" >> $GITHUB_OUTPUT
            echo "MINOR=$(echo "$V" | cut -d'.' -f2)" >> $GITHUB_OUTPUT
            echo "PATCH=$(echo "$V" | cut -d'.' -f3)" >> $GITHUB_OUTPUT
          fi

      - name: Calculate next version (PHP-specific labels)
        id: calc-version
        run: |
          MAJOR=${{ steps.parse-version.outputs.MAJOR }}
          MINOR=${{ steps.parse-version.outputs.MINOR }}
          PATCH=${{ steps.parse-version.outputs.PATCH }}

          LABELS='${{ join(github.event.pull_request.labels.*.name, ',') }}'

          # === –ö–ê–¢–ï–ì–û–†–ò–ò –î–õ–Ø SEMVER (PHP-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ) ===

          # MAJOR: –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (–ª–æ–º–∞—é—Ç —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å)
          if echo "$LABELS" | grep -iqE '\b(break|breaking|major|deprecated|refactor|api-change|bc-break)\b'; then
            NEW_MAJOR=$((MAJOR + 1))
            NEW_MINOR=0
            NEW_PATCH=0

          # MINOR: –Ω–æ–≤—ã–µ —Ñ–∏—á–∏, —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
          elif echo "$LABELS" | grep -iqE '\b(feature|enhancement|new|add|implement|psr|standards|coding-style|php8|php8.1|php8.2|php8.3|dependency-update)\b'; then
            NEW_MAJOR=$MAJOR
            NEW_MINOR=$((MINOR + 1))
            NEW_PATCH=0

          # PATCH: –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è, –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è, —Ç–µ—Å—Ç—ã
          elif echo "$LABELS" | grep -iqE '\b(fix|bug|patch|hotfix|security|vulnerability|test|coverage|performance|optimization|ci|cd|docs|documentation|changelog|readme)\b'; then
            NEW_MAJOR=$MAJOR
            NEW_MINOR=$MINOR
            NEW_PATCH=$((PATCH + 1))

          # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî PATCH (–µ—Å–ª–∏ –º–µ—Ç–æ–∫ –Ω–µ—Ç –∏–ª–∏ –æ–Ω–∏ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω—ã)
          else
            NEW_MAJOR=$MAJOR
            NEW_MINOR=$MINOR
            NEW_PATCH=$((PATCH + 1))
          fi

          NEXT_VERSION="v${NEW_MAJOR}.${NEW_MINOR}.${NEW_PATCH}"
          VERSION_SHORT="${NEW_MAJOR}.${NEW_MINOR}.${NEW_PATCH}"

          echo "NEXT_VERSION=$NEXT_VERSION" >> $GITHUB_OUTPUT
          echo "VERSION_SHORT=$VERSION_SHORT" >> $GITHUB_OUTPUT

      - name: Generate Changelog (PHP-friendly)
        id: gen-changelog
        run: |
          PR_NUM=${{ github.event.pull_request.number }}
          PR_TITLE='${{ github.event.pull_request.title }}'
          PR_URL='${{ github.event.pull_request.html_url }}'
          AUTHOR='${{ github.event.pull_request.user.login }}'
          LABELS_STR='${{ join(github.event.pull_request.labels.*.name, ', ') }}'

          changelog="## Release ${{ steps.calc-version.outputs.NEXT_VERSION }} (Draft)\n\n"
          changelog+="> üõ† This is an auto-generated draft for a PHP project. Review before publishing.\n\n"

          changelog+="### PR Summary\n"
          changelog+="- **Title:** [$PR_TITLE]($PR_URL)\n"
          changelog+="- **Number:** #$PR_NUM\n"
          changelog+="- **Author:** @$AUTHOR\n"
          changelog+="- **Labels:** $LABELS_STR\n\n"

          changelog+="### Type of Changes\n"

          # –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ —Ç–∏–ø–∞–º (–Ω–∞ –æ—Å–Ω–æ–≤–µ –º–µ—Ç–æ–∫)
          if echo "$LABELS_STR" | grep -iq 'feature'; then
            changelog+="- ‚ú® New Features\n"
          fi
          if echo "$LABELS_STR" | grep -iqE 'fix|bug|hotfix|security'; then
            changelog+="- üêû Bug Fixes & Security\n"
          fi
          if echo "$LABELS_STR" | grep -iqE 'refactor|deprecated|api-change'; then
            changelog+="- ‚öí Refactoring & Deprecations\n"
          fi
          if echo "$LABELS_STR" | grep -iqE 'test|coverage'; then
            changelog+="- üß™ Tests & Coverage\n"
          fi
          if echo "$LABELS_STR" | grep -iqE 'docs|readme|changelog'; then
            changelog+="- üìù Documentation\n"
          fi
          if echo "$LABELS_STR" | grep -iqE 'performance|optimization'; then
            changelog+="- üöÄ Performance\n"
          fi
          if echo "$LABELS_STR" | grep -iqE 'ci|cd'; then
            changelog+="- üîß CI/CD Improvements\n"
          fi
          changelog+="\n"

          changelog+="### Details\n"
          changelog+="- $PR_TITLE ([#$PR_NUM]($PR_URL))\n\n"

          changelog+="### Checklist\n"
          changelog+="- [ ] ‚úÖ Verify backward compatibility (if MAJOR/MINOR)\n"
          changelog+="- [ ] üìÑ Update UPGRADE.md/CHANGELOG.md\n"
          changelog+="- [ ] üß™ Run full test suite (PHPUnit, Pest, etc.)\n"
          changelog+="- [ ] üîç Check for deprecation notices\n"
          changelog+="- [ ] üåê Test with supported PHP versions (8.0‚Äì8.3)\n\n"

          changelog+="---\n"
          changelog+="_Generated automatically for PHP project on $(date +'%Y-%m-%d %H:%M')_\n"
          changelog+="_Workflow: PR ‚Üí Release Draft (SemVer + PHP labels)_\n"


          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          echo "$changelog" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT


      - name: Create/Update Draft Release
        uses: actions/create-release@v1
        env: